# ADR-016: PWA and Offline Support

**Status:** Accepted

## Context

Frantic Search is a fully client-side search engine. Once the browser has the app shell (~40 KB of JS/CSS) and card data (~2.5 MB gzipped `columns.json`), the entire search experience works without any server. This makes it an ideal candidate for offline use — a common scenario is a card store basement with spotty wifi, where a player has used Frantic Search before and wants to search cards without connectivity.

Today, every page load re-fetches all assets from GitHub Pages. If the network is unavailable, the app fails entirely. The browser's built-in HTTP cache helps on repeat visits, but provides no offline guarantee and no user-visible "installed app" experience.

A related gap: the `<head>` of `index.html` has no Open Graph or social media meta tags, so sharing a link to Frantic Search on Discord, Twitter/X, or iMessage produces a bare URL with no preview image or description.

## Decision

### 1. Add a Service Worker via `vite-plugin-pwa`

Use [`vite-plugin-pwa`](https://vite-pwa-org.netlify.app/) (which wraps [Workbox](https://developer.chrome.com/docs/workbox/)) to generate a service worker at build time.

**Caching strategy:**

| Asset | Strategy | Rationale |
|---|---|---|
| App shell (HTML, JS, CSS, fonts) | **Precache** (build-time manifest) | Content-hashed by Vite; new deploys produce new filenames. Workbox precaching handles versioning automatically. |
| `columns.json` | **Cache-first, runtime** | Too large to precache (~2.5 MB gzipped). Cached on first use. See _Content-hashed data file_ below. |
| Scryfall art crop images | **Stale-while-revalidate, runtime** | Opportunistically cache images the user has already seen. LRU eviction (cap at ~500 entries). Graceful fallback: color identity placeholder is already rendered. |

**Update lifecycle:** `registerType: 'autoUpdate'` — the new service worker activates automatically on the next navigation. No "update available" prompt needed; the app is small and loads fast.

### 2. Content-hash the data file

Rename the build output from `columns.json` to `columns.<hash>.json` (where `<hash>` is a content hash computed during the ETL `process` step or at Vite build time). This ensures:

- The service worker can distinguish stale vs. fresh card data.
- The browser (and CDN) can cache it immutably with long `Cache-Control` headers.
- Deployments that update card data (daily Scryfall sync) produce a new filename, busting the cache.

The worker's `fetch()` URL must reference the hashed filename. One approach: the Vite build injects the filename via an import or a global constant.

### 3. Add a Web App Manifest

Include a `manifest.json` (generated by `vite-plugin-pwa`) with:

- `name`: "Frantic Search"
- `short_name`: "Frantic"
- `description`: "Instant MTG card search"
- `display`: "standalone"
- `theme_color`: "#030712" (matches existing `<meta name="theme-color">`)
- `background_color`: "#030712"
- Icon: the Frantic Search card art crop from Scryfall's CDN

This enables "Add to Home Screen" on mobile and provides an app-like experience.

### 4. Add Open Graph and social meta tags

Add to `index.html`:

```html
<meta property="og:title" content="Frantic Search" />
<meta property="og:description" content="Instant MTG card search — filter 30,000+ cards on every keystroke" />
<meta property="og:image" content="https://cards.scryfall.io/art_crop/front/1/9/1904db14-6df7-424f-afa5-e3dfab31300a.jpg" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="description" content="Instant MTG card search — filter 30,000+ cards on every keystroke" />
```

The OG image and manifest icon both reference the Frantic Search card art crop hot-linked from Scryfall's CDN. No local image assets are needed.

## Consequences

- **Positive:** The app works fully offline after first visit. Card store basement scenario is solved.
- **Positive:** "Add to Home Screen" gives a native app feel on mobile — full-screen, themed, instant launch.
- **Positive:** Content-hashed `columns.json` enables immutable caching and correct cache invalidation on data updates.
- **Positive:** Social media links show a rich preview with title, description, and image.
- **Positive:** Scryfall art crops are opportunistically cached, but the color identity placeholders already provide a graceful offline fallback — no broken image icons.
- **Negative:** Adds `vite-plugin-pwa` as a build dependency.
- **Negative:** Service worker update lifecycle adds a small amount of complexity. Bugs in the service worker can cache stale assets — Workbox mitigates this with content-hash-based precaching, but it's a new failure mode to be aware of.
- **Negative:** The manifest icon is a cross-origin Scryfall art crop (landscape, not square). Some platforms may not display it ideally. Custom icons can be added later if needed.
- **Negative:** GitHub Pages does not support custom `Cache-Control` headers, so the content-hashed filename is the primary cache-busting mechanism (the CDN's default caching is acceptable given the hashed filenames).
